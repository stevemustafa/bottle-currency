--- 
artifacts: 
  files: imagedefinitions.json
phases: 
  build: 
    commands: 
      - "echo Starting build phase"
      - "pip3 install -r requirements.txt"
      - "docker build -t $REPOSITORY_URI:latest ."
      - "docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG"
  install: 
    runtime-versions: 
      docker: 18
  post_build: 
    commands: 
      - "echo Build completed on `date`"
      - "echo Pushing the Docker image to ECR..."
      - "docker push $REPOSITORY_URI:latest"
      - "docker push $REPOSITORY_URI:$IMAGE_TAG"
      - echo Writing image definitions file...
      - printf '[{"name":"hello-world","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
      - cat imagedefinitions.json
  pre_build: 
    commands: 
      - "echo Logging in to Amazon ECR..."
      - "aws --version"
      - REPOSITORY_URI=334033517520.dkr.ecr.eu-west-1.amazonaws.com/sm-mb-ecr-repo
      - "COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)"
      - "IMAGE_TAG=${COMMIT_HASH:=latest}"
      - "$(aws ecr get-login --no-include-email --region eu-west-1)"
version: 0.2
